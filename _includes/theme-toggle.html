<div class="toggleWrapper">
  <input type="checkbox" class="dn" id="theme-toggle" aria-label="Toggle theme" />
  <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
    <span class="star star--1"></span>
    <span class="star star--2"></span>
    <span class="star star--3"></span>
    <span class="star star--4"></span>
    <span class="star star--5"></span>
    <span class="star star--6"></span>
  </label>
</div>

<script>
(() => {
  const root   = document.documentElement;
  const toggle = document.getElementById('theme-toggle');

  const getSystemPref = () =>
    window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches
      ? 'light' : 'dark';

  const applyTheme = (theme) => {
    // data-theme cho CSS
    root.setAttribute('data-theme', theme);

    // optional: class hooks nếu CSS của bạn có dùng
    root.classList.toggle('theme--light', theme === 'light');
    root.classList.toggle('theme--dark',  theme !== 'light');

    // trạng thái UI (checkbox checked = dark)
    toggle.checked = (theme === 'dark');

    // nếu bạn có CSS dựa trên class trên chính input:
    toggle.classList.toggle('light', theme === 'dark'); // moon
    toggle.classList.toggle('dark',  theme === 'light'); // sun

    localStorage.setItem('theme', theme);
  };

  // 1) lấy theme đã lưu, nếu chưa có thì theo hệ thống
  const initial = localStorage.getItem('theme') || getSystemPref();
  applyTheme(initial);

  // 2) click để đổi
  toggle.addEventListener('change', () => {
    applyTheme(toggle.checked ? 'dark' : 'light');
  });

  // 3) (tuỳ chọn) cập nhật khi hệ thống đổi, chỉ khi user CHƯA chọn thủ công
  if (window.matchMedia) {
    const mq = window.matchMedia('(prefers-color-scheme: light)');
    const onChange = (e) => {
      if (!localStorage.getItem('theme')) {
        applyTheme(e.matches ? 'light' : 'dark');
      }
    };
    if (mq.addEventListener) mq.addEventListener('change', onChange);
    else mq.addListener(onChange); // Safari cũ
  }
})();
</script>
